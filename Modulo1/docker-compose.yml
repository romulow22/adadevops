version: "3.2"
services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: 'rabbitmq'
    ports:
      - 5672:5672
      - 8080:15672
    volumes:
      - ./rabbitmq/data/:/var/lib/rabbitmq/
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    networks:
      - default_net
  redis:
    image: redis/redis-stack:7.2.0-v8
    container_name: redis
    hostname: redis
    ports:
      - 6379:6379
      - 8081:8001
    volumes:
      - ./redis/data/:/data/
    environment:
      - REDIS_ARGS=--save 60 1000 --appendonly yes
      - REDISTIMESERIES_ARGS="RETENTION_POLICY=20"
    networks:
      - default_net
  minio:
    image: minio/minio:RELEASE.2024-03-07T00-43-48Z
    command: server /data --console-address ":9001"
    container_name: minio
    ports:
      - '9000:9000'
      - '8082:9001'
    networks:
      - default_net
    volumes:
      - ./minio/data/:/data
    environment:
      - MINIO_ROOT_USER_FILE=minio_root_usr
      - MINIO_ROOT_PASSWORD_FILE=minio_root_pwd
    secrets:
      - minio_root_usr
      - minio_root_pwd
  minio-mc:
    container_name: minio-mc
    image: minio/mc:RELEASE.2024-03-07T00-31-49Z
    stdin_open: true # docker run -i
    tty: true        # docker run -t
    depends_on:
      - minio
    networks:
      - default_net
#    environment:
#      - MC_HOST_myminio=http://admin:minioadmin@minio:9000
#    entrypoint: /bin/bash
    secrets:
      - minio_root_usr
      - minio_root_pwd
    entrypoint: >
      /bin/sh -c "
      export MINIO_ROOT_USER_FILE=/run/secrets/minio_root_usr;
      export MINIO_ROOT_PASSWORD_FILE=/run/secrets/minio_root_pwd;
      export MINIO_ROOT_USER=$$(cat $$MINIO_ROOT_USER_FILE);
      export MINIO_ROOT_PASSWORD=$$(cat $$MINIO_ROOT_PASSWORD_FILE);
      export MC_HOST_myminio=http://$$MINIO_ROOT_USER:$$MINIO_ROOT_PASSWORD@minio:9000;
      /bin/bash"
#  app:
#    image: local/pythonapp:1.0
#    container_name: app
#    ports:
#      - '8083:5000'
#    networks:
#      - default_net
secrets:
  minio_root_usr:
    file: ./minio/secrets/minio_usr.txt
  minio_root_pwd:
    file: ./minio/secrets/minio_pwd.txt
networks:
  default_net:
    driver: bridge
    name: rede-default    